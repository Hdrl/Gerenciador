{% extends 'base.html'%}
{% load atividades_tags %}


{% block style %}
      /* CSS para a interatividade (sem alterações) */
    .project-card {
        cursor: pointer;
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .project-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .selected-card {
        border: 2px solid var(--bs-primary);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .fade-in-section {
        animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
{% endblock %}
{% block content %}
{% csrf_token %}
<div class="container mt-4">
    <h3>Demandas Pendentes</h3>
    <p class="text-muted">Selecione um projeto para ver mais detalhes.</p>

    <div class="d-flex flex-wrap gap-3">
        {% for projeto in projetos %}
            {% with demandas_pendente=projeto.todas_demandas|pendentes %}
                {% if demandas_pendente %}   
                    <div class="card project-card" 
                        style="width: 22rem;"
                        data-project-id="{{ projeto.id }}"
                        data-project-nome="{{ projeto.nome }}"
                        data-project-status="{{ projeto.get_status_display }}"
                        data-project-status-class="{{ projeto.get_status_badge_class }}"
                        data-project-descricao="{{ projeto.descricao|default:'Este projeto não possui uma descrição detalhada.' }}">
                        
                        <div class="card-body">
                            <h5 class="card-title">{{ projeto.nome }}</h5>
                            <span class="badge {{ projeto.get_status_badge_class }}">{{ projeto.get_status_display }}</span>                   

                            <table class="table table-sm table-borderless mt-3">
                                <thead>
                                    <tr>
                                        <th scope="col">Produto</th>
                                        <th scope="col" class="text-center">Qtd.</th>
                                        <th scope="col" class="text-center">Finalizado?</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for demanda in demandas_pendente|slice:":4"%}
                                        <tr>
                                            <td>
                                                <strong>{{ demanda.produto.codigo_item }}</strong>
                                                {% if demanda.descricao %}
                                                    <small class="text-muted d-block">{{ demanda.descricao|truncatechars:30 }}</small>
                                                {% else %}
                                                    <small class="text-muted d-block">{{ demanda.produto.descricao|truncatechars:30 }}</small>
                                                {% endif %}
                                            </td>
                                            <td class="text-center align-middle">
                                                <span class="badge bg-secondary rounded-pill">
                                                    {{ demanda.quantidade }}
                                                </span>
                                            </td>
                                            <td class="text-center align-middle">
                                                <input class="check-finalizado" type="checkbox" data-demanda-id="{{demanda.id}}">
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    {% if demandas_pendente|length > 4 %}
                                        {% with remaining_count=demandas_pendente|length|add:"-4" %}
                                            <tr>
                                                <td colspan="2" class="text-center pt-2">
                                                    <small class="text-muted fst-italic">
                                                        ... e mais {{ remaining_count }} demanda{{ remaining_count|pluralize }}.
                                                    </small>
                                                </td>
                                            </tr>
                                        {% endwith %}
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endif %}
            {% endwith %}
        {% endfor %}
    </div>

    <hr class="my-4">

    <div id="project-details-section" class="d-none">
    <h2 id="details-title"></h2>
    <p>
        <strong>Status:</strong>
        <span id="details-status-badge" class="badge"></span>
    </p>
    <p id="details-description" class="lead"></p>

    <div class="mt-4">
        <ul class="nav nav-tabs" id="project-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#acesso-remoto-pane" type="button" role="tab">Acesso Remoto</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#sistema-pane" type="button" role="tab">Sistema</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#documentacao-pane" type="button" role="tab">Documentação</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#equipamento-pane" type="button" role="tab">Equipamento</button>
            </li>
             <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#processos-pane" type="button" role="tab">Processos</button>
            </li>
             <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#modulos-pane" type="button" role="tab">Módulos</button>
            </li>
        </ul>

        <div class="tab-content border border-top-0 p-3" id="project-tab-content">
            <div class="tab-pane fade show active" id="equipamento-pane" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center bg-light p-2 mb-3 rounded-top">
                    <h6 class="mb-0 text-muted fw-bold">Equipamentos vinculados ao Projeto</h6>
                    <div class="btn-group" role="group">
                        <a href="#" id="add-equipment-link" class="btn btn-success btn-sm" title="Adicionar Equipamento">+</a>
                        <a href="#" id="edit-equipment-link" class="btn btn-primary btn-sm" title="Editar Equipamento">&#9998;</a> <a href="#" id="remove-equipment-link" class="btn btn-danger btn-sm" title="Remover Equipamento">-</a>
                    </div>
                </div>

                <div id="equipment-list-placeholder">
                     <p class="text-center text-muted">Selecione um projeto para ver os equipamentos.</p>
                </div>
            </div>

            <div class="tab-pane fade" id="acesso-remoto-pane" role="tabpanel"><p>Conteúdo de Acesso Remoto...</p></div>
            <div class="tab-pane fade" id="sistema-pane" role="tabpanel"><p>Conteúdo de Sistema...</p></div>
            <div class="tab-pane fade" id="documentacao-pane" role="tabpanel"><p>Conteúdo de Documentação...</p></div>
            <div class="tab-pane fade" id="processos-pane" role="tabpanel"><p>Conteúdo de Processos...</p></div>
            <div class="tab-pane fade" id="modulos-pane" role="tabpanel"><p>Conteúdo de Módulos...</p></div>
        </div>
    </div>
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    
    const cards = document.querySelectorAll('.project-card');
    const detailsSection = document.getElementById('project-details-section');
    const detailsTitle = document.getElementById('details-title');
    const detailsStatusBadge = document.getElementById('details-status-badge');
    const detailsDescription = document.getElementById('details-description');
    const checkFinalizado = document.querySelectorAll('.check-finalizado');

    // Seleciona os links dos botões que acabamos de criar
    const addEquipmentLink = document.getElementById('add-equipment-link');
    const editEquipmentLink = document.getElementById('edit-equipment-link');
    const removeEquipmentLink = document.getElementById('remove-equipment-link');

    checkFinalizado.forEach(checkbox => {
        checkbox.addEventListener('change', function(event) {
            const checkboxAtual = this;
            demandaId = this.dataset.demandaId;
            const isFinalizado = this.checked;  

            atualizarDemanda(demandaId, { 'finalizado': isFinalizado}, checkboxAtual);
        });
    });

    cards.forEach(card => {
        card.addEventListener('click', function() {
            // Remove a seleção de outros cartões
            cards.forEach(c => c.classList.remove('selected-card'));
            this.classList.add('selected-card');

            // Pega os dados do cartão clicado
            const projectId = this.dataset.projectId;
            const nome = this.dataset.projectNome;
            const status = this.dataset.projectStatus;
            const statusClass = this.dataset.projectStatusClass;
            const descricao = this.dataset.projectDescricao;

            detailsTitle.textContent = nome;
            //detailsDescription.textContent = descricao;
            detailsStatusBadge.textContent = status;
            detailsStatusBadge.className = 'badge ' + statusClass;

            addEquipmentLink.href = `/projetos/${projectId}/equipamentos/adicionar/`;
            editEquipmentLink.href = `/projetos/${projectId}/equipamentos/editar/`; // Geralmente precisa de um ID de equipamento
            removeEquipmentLink.href = `/projetos/${projectId}/equipamentos/remover/`; // Idem

            detailsSection.classList.remove('d-none');
            detailsSection.classList.remove('fade-in-section');
            void detailsSection.offsetWidth; // Força o repaint para reiniciar a animação
            detailsSection.classList.add('fade-in-section');
        });
    });

    if (cards.length > 0) {
        cards[0].click();
    }
    
    function atualizarDemanda(demandaId, dadosParaAtualizar, checkboxElement) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const url = `/demanda/editar/${demandaId}/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(dadosParaAtualizar)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'sucesso') {
                console.log('Sucesso:', data.mensagem);
                if(dadosParaAtualizar.finalizado)
                    checkboxElement.closest('tr').remove();
            } else {
                console.error('Erro:', data.mensagem);
                if(checkboxElement) checkboxElement.checked = !dadosParaAtualizar.finalizado;
            }
        })
        .catch(error => {
            console.error('Erro de rede:', error);
            if(checkboxElement) checkboxElement.checked = !dadosParaAtualizar.finalizado;
        });
    }   
});
</script>

{% endblock %}